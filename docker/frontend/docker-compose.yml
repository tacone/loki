version: '3.4'

services:
  frontend:
    image: survey-node-frontend
    build:
      context: ./
      dockerfile: ./docker/frontend/Dockerfile
      args:
        # IMPORTANT: we need to specify all the env needed by the build
        # either here AND in the Dockerfile :(

        BUILD_COMMAND: >-
          yarn run build
          && brotli-compress /app/.next/static
        NODE_ENV: production
        NEXT_PUBLIC_GRAPHQL_ENDPOINT: ${GRAPHQL_ENDPOINT}
    restart: "always"
    volumes:
      - ./data/node/npm:/root/.npm
      - /tmp/survey/frontend:/tmp
      - ./scripts/bin/install-files:/usr/local/bin/install-files:ro
      - frontend-static:/static

    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_GRAPHQL_ENDPOINT=${GRAPHQL_ENDPOINT}
      - NEXT_TELEMETRY_DISABLED=1
      - STATIC_FOLDER=/app/.next/static
    working_dir: /app
    command: >-
      sh -c '
      install-files /app/.next/static /static
      && yarn run start
      '
    ports:
      - ${FRONTEND_PORT:-7000}:3000

volumes:
  # we need to set up a volume so nginx sees the compiled files from sapper
  frontend-static: